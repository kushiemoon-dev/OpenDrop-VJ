name: Release

on:
  push:
    tags: ['v*']

permissions:
  contents: write

jobs:
  build-linux:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libasound2-dev \
            libpipewire-0.3-dev \
            libspa-0.2-dev \
            libgl-dev \
            libglu1-mesa-dev \
            pkg-config \
            nasm \
            cmake \
            ninja-build \
            file \
            libfuse2 \
            squashfs-tools

      - name: Install libprojectM via vcpkg
        run: |
          git clone https://github.com/microsoft/vcpkg.git ~/vcpkg
          ~/vcpkg/bootstrap-vcpkg.sh
          # x64-linux is the standard dynamic triplet for Linux
          ~/vcpkg/vcpkg install projectm:x64-linux
          VCPKG_INSTALLED=~/vcpkg/installed/x64-linux
          echo "=== vcpkg lib contents ==="
          ls -la "$VCPKG_INSTALLED/lib/" || true
          echo "=== vcpkg include contents ==="
          ls -la "$VCPKG_INSTALLED/include/" || true
          find "$VCPKG_INSTALLED/include" -name "*.h" | head -20 || true
          echo "=== Setting environment ==="
          echo "PKG_CONFIG_PATH=$VCPKG_INSTALLED/lib/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV
          echo "LD_LIBRARY_PATH=$VCPKG_INSTALLED/lib:$LD_LIBRARY_PATH" >> $GITHUB_ENV
          echo "LIBRARY_PATH=$VCPKG_INSTALLED/lib:$LIBRARY_PATH" >> $GITHUB_ENV
          echo "PROJECTM_4_DIR=$VCPKG_INSTALLED" >> $GITHUB_ENV
          echo "PROJECTM_4_LIB_DIR=$VCPKG_INSTALLED/lib" >> $GITHUB_ENV
          echo "PROJECTM_4_INCLUDE_DIR=$VCPKG_INSTALLED/include" >> $GITHUB_ENV
          echo "CPATH=$VCPKG_INSTALLED/include:$CPATH" >> $GITHUB_ENV

      - uses: pnpm/action-setup@v2
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: '. -> target'

      - name: Install frontend dependencies
        run: pnpm install

      - name: Build renderer sidecar
        run: |
          echo "=== Building opendrop-renderer ==="
          cargo build --release -p opendrop-renderer
          mkdir -p src-tauri/binaries
          cp target/release/opendrop-renderer src-tauri/binaries/opendrop-renderer-x86_64-unknown-linux-gnu
          chmod +x src-tauri/binaries/opendrop-renderer-x86_64-unknown-linux-gnu
          echo "=== Renderer sidecar ready ==="
          ls -la src-tauri/binaries/

      - name: Build Tauri app
        run: |
          echo "=== Starting Tauri build ==="
          pnpm tauri build --verbose
          echo "=== Build exit code: $? ==="

      - name: List bundle contents
        run: |
          echo "=== Bundle directory contents ==="
          find target/release/bundle -type f 2>/dev/null || echo "Bundle directory not found"
          ls -laR target/release/bundle/ 2>/dev/null || true

      - uses: actions/upload-artifact@v4
        with:
          name: linux-artifacts
          path: |
            target/release/bundle/appimage/*.AppImage
            target/release/bundle/deb/*.deb
          if-no-files-found: error

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install WiX Toolset and NSIS
        run: |
          choco install wixtoolset nsis -y
          echo "C:\Program Files (x86)\WiX Toolset v3.14\bin" >> $env:GITHUB_PATH

      - name: Install libprojectM via vcpkg
        shell: pwsh
        run: |
          git clone https://github.com/microsoft/vcpkg.git C:\vcpkg
          C:\vcpkg\bootstrap-vcpkg.bat
          C:\vcpkg\vcpkg install projectm:x64-windows-static
          $vcpkgInstalled = "C:\vcpkg\installed\x64-windows-static"
          echo "=== vcpkg lib directory contents ==="
          Get-ChildItem -Path "$vcpkgInstalled\lib" -Recurse | ForEach-Object { $_.FullName }
          echo "=== vcpkg include directory contents ==="
          Get-ChildItem -Path "$vcpkgInstalled\include" -Recurse -Directory | ForEach-Object { $_.FullName }
          echo "=== Setting environment variables ==="
          echo "VCPKG_ROOT=C:\vcpkg" >> $env:GITHUB_ENV
          echo "PKG_CONFIG_PATH=$vcpkgInstalled\lib\pkgconfig" >> $env:GITHUB_ENV
          echo "PROJECTM_4_DIR=$vcpkgInstalled" >> $env:GITHUB_ENV
          echo "PROJECTM_4_LIB_DIR=$vcpkgInstalled\lib" >> $env:GITHUB_ENV
          echo "PROJECTM_4_INCLUDE_DIR=$vcpkgInstalled\include" >> $env:GITHUB_ENV

      - uses: pnpm/action-setup@v2
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: '. -> target'

      - name: Install frontend dependencies
        run: pnpm install

      - name: Build renderer sidecar
        shell: pwsh
        run: |
          echo "=== Building opendrop-renderer ==="
          cargo build --release -p opendrop-renderer
          New-Item -ItemType Directory -Force -Path "src-tauri/binaries"
          Copy-Item "target/release/opendrop-renderer.exe" "src-tauri/binaries/opendrop-renderer-x86_64-pc-windows-msvc.exe"
          echo "=== Renderer sidecar ready ==="
          Get-ChildItem "src-tauri/binaries"

      - name: Build Tauri app
        run: pnpm tauri build --verbose

      - name: List bundle contents
        shell: pwsh
        run: |
          echo "=== Bundle directory contents ==="
          if (Test-Path "target/release/bundle") {
            Get-ChildItem -Recurse "target/release/bundle" | ForEach-Object { $_.FullName }
          } else {
            echo "Bundle directory does not exist"
          }

      - uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: |
            target/release/bundle/msi/*.msi
            target/release/bundle/nsis/*.exe
          if-no-files-found: error

  create-release:
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display artifacts
        run: |
          echo "=== Current directory ==="
          pwd
          echo "=== Directory listing ==="
          ls -laR .
          echo "=== Looking for artifacts ==="
          find . -type f -name "*.AppImage" -o -name "*.deb" -o -name "*.msi" -o -name "*.exe" 2>/dev/null || true

      - uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: |
            artifacts/**/*.AppImage
            artifacts/**/*.deb
            artifacts/**/*.msi
            artifacts/**/*.exe
          draft: true
          generate_release_notes: true
          fail_on_unmatched_files: false
